<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TÃ i khoáº£n â€” Cá»­a hÃ ng SÃ¡ch Viá»‡t</title>
  
  <link rel="stylesheet" href="./css/style_sanpham.css">

  <style>
    .form-wrapper {
      background: #fff;
      padding: 20px 40px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      width: 350px; 
      margin: 40px auto; 
    }

    .form-wrapper h2 { text-align: center; margin-bottom: 20px; }
    .form-wrapper input[type="text"],
    .form-wrapper input[type="password"],
    .form-wrapper input[type="email"],
    .form-wrapper input[type="tel"] {
      width: 100%; padding: 8px; margin: 5px 0 15px 0;
      border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; 
    }
    .form-wrapper button {
      width: 100%; padding: 10px; margin: 5px 0; border: none;
      border-radius: 4px; background: #007bff; color: white;
      cursor: pointer; font-size: 16px;
    }
    .form-wrapper button:hover { background: #0056b3; }
    .form-wrapper .secondary-btn { background: #6c757d; }
    .form-wrapper .secondary-btn:hover { background: #495057; }
    .form-wrapper .error { color: red; text-align: center; margin-bottom: 10px; }
    .hidden { display: none; }
    .form-wrapper textarea { width: 100%; height: 50px; resize: none; }
    .form-wrapper label { font-weight: bold; }
    .form-wrapper p { font-size: 14px; line-height: 1.6; }

    #orders-list {
      list-style-type: none; padding: 0;
      max-height: 400px; overflow-y: auto;
      background: #fdfdfd; border-top: 1px solid #eee; padding-top: 10px;
    }
    .order-card {
      background: #f9f9f9; border: 1px solid #eee; border-radius: 8px;
      padding: 12px; margin-bottom: 10px;
    }
    .order-card-header {
      display: flex; justify-content: space-between; align-items: center;
      font-weight: bold; font-size: 14px; border-bottom: 1px solid #ddd;
      padding-bottom: 8px; margin-bottom: 8px;
    }
    .order-card-header .order-id { color: var(--primary); font-size: 13px; }
    .order-card-header .order-total { color: #2c3e50; font-size: 15px; }
    .order-card-body { font-size: 13px; color: #555; }
    .order-card-body p { margin: 4px 0; }
    .order-items-list {
      font-size: 12px; padding-left: 16px;
      color: #777; margin-top: 5px;
    }
    .order-items-list li { margin-bottom: 3px; }
  </style>
</head>
<body>

<header class="site-header">
  <div class="container">
    <div class="header-top">
      <div class="brand">
        <div class="logo" aria-hidden="true">ğŸ“˜</div>
        <div>
          <div style="font-size:20px">Cá»­a hÃ ng SÃ¡ch Viá»‡t</div>
          <div style="font-size:12px;color:rgba(255,255,255,0.85)">Quáº£n lÃ½ tÃ i khoáº£n</div>
        </div>
      </div>
      <nav class="user-nav">
        <a href="./sanpham.html" title="Trang chá»§">
          <span class="icon">ğŸ </span>
          <span class="label">Trang chá»§</span>
        </a>
        <a href="./giohang.html" title="Giá» hÃ ng">
          <span class="icon">ğŸ›’</span>
          <span class="label">Giá» hÃ ng</span>
        </a>
        <a href="#" title="TÃ i khoáº£n" class="active">
          <span class="icon">ğŸ‘¤</span>
          <span class="label">TÃ i khoáº£n</span>
        </a>
      </nav>
    </div>
  </div>
</header>

<main>
  <div class="container"> 
    
    <!-- ÄÄ‚NG NHáº¬P -->
    <div class="form-wrapper" id="login-container">
      <h2>ÄÄƒng Nháº­p</h2>
      <div class="error" id="login-error"></div>
      <input type="text" id="login-username" placeholder="TÃªn Ä‘Äƒng nháº­p">
      <input type="password" id="login-password" placeholder="Máº­t kháº©u">
      <button id="login-btn">ÄÄ‚NG NHáº¬P</button>
      <button class="secondary-btn" id="goto-register">CHUYá»‚N SANG ÄÄ‚NG KÃ</button>
    </div>

    <!-- ÄÄ‚NG KÃ -->
    <div class="form-wrapper hidden" id="register-container">
      <h2>ÄÄƒng KÃ­</h2>
      <div class="error" id="register-error"></div>
      <input type="text" id="register-username" placeholder="TÃªn Ä‘Äƒng kÃ­">
      <input type="password" id="register-password" placeholder="Máº­t kháº©u">
      <input type="password" id="register-confirm-password" placeholder="XÃ¡c nháº­n máº­t kháº©u">
      <input type="email" id="register-email" placeholder="Email">
      <button id="register-btn">ÄÄ‚NG KÃ</button>
      <button class="secondary-btn" id="goto-login">QUAY Láº I ÄÄ‚NG NHáº¬P</button>
    </div>

    <!-- Äá»”I Máº¬T KHáº¨U Báº®T BUá»˜C -->
    <div class="form-wrapper hidden" id="force-change-password-container">
      <h2>âš ï¸ YÃªu cáº§u Ä‘á»•i máº­t kháº©u</h2>
      <p style="text-align: center; color: #666; margin-bottom: 20px;">
        Admin yÃªu cáº§u báº¡n Ä‘á»•i máº­t kháº©u.<br>
        Vui lÃ²ng Ä‘á»•i máº­t kháº©u Ä‘á»ƒ tiáº¿p tá»¥c sá»­ dá»¥ng.
      </p>
      <div class="error" id="force-password-error"></div>
      
      <label>Máº­t kháº©u hiá»‡n táº¡i:</label>
      <input type="password" id="force-old-password" placeholder="Nháº­p máº­t kháº©u hiá»‡n táº¡i">
      
      <label>Máº­t kháº©u má»›i:</label>
      <input type="password" id="force-new-password" placeholder="Nháº­p máº­t kháº©u má»›i ">
      
      <label>XÃ¡c nháº­n máº­t kháº©u má»›i:</label>
      <input type="password" id="force-confirm-new-password" placeholder="Nháº­p láº¡i máº­t kháº©u má»›i">
      
      <button id="force-confirm-password-btn">XÃC NHáº¬N Äá»”I Máº¬T KHáº¨U</button>
      <button class="secondary-btn" id="force-logout-btn">ÄÄ‚NG XUáº¤T</button>
    </div>

    <!-- TRANG CHÃNH -->
    <div class="form-wrapper hidden" id="home-container">
      <h2 id="home-welcome">Trang ChÃ­nh</h2>
      <button id="go-products">Xem Sáº£n Pháº©m</button>
      <button id="go-info">ThÃ´ng Tin KhÃ¡ch HÃ ng</button>
      <button class="secondary-btn" id="logout-btn">ÄÄ‚NG XUáº¤T</button>
    </div>

    <!-- THÃ”NG TIN KHÃCH HÃ€NG -->
    <div class="form-wrapper hidden" id="info-container">
      <h2>ThÃ´ng Tin KhÃ¡ch HÃ ng</h2>
      <label>TÃªn khÃ¡ch hÃ ng:</label>
      <input type="text" id="info-username" disabled>
      <label>Sá»‘ Ä‘iá»‡n thoáº¡i:</label>
      <input type="tel" id="info-phone">
      <label>Email:</label>
      <input type="email" id="info-email">
      
      <label>Äá»‹a chá»‰ (Máº·c Ä‘á»‹nh):</label>
      <input type="text" id="info-address" placeholder="Sá»‘ nhÃ , Ä‘Æ°á»ng, phÆ°á»ng/xÃ£...">
      
      <button id="save-info">LÆ°u ThÃ´ng Tin</button>
      <button id="change-password">Äá»•i Máº­t Kháº©u</button>
      <button id="view-orders">Danh SÃ¡ch Mua HÃ ng</button>
      <button class="secondary-btn" id="back-home">Quay Láº¡i Trang ChÃ­nh</button>

      <div class="hidden" id="change-password-container" style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
        <h3>Äá»•i Máº­t Kháº©u</h3>
        <div class="error" id="password-error"></div>
        <input type="password" id="old-password" placeholder="Máº­t kháº©u cÅ©">
        <input type="password" id="new-password" placeholder="Máº­t kháº©u má»›i">
        <input type="password" id="confirm-new-password" placeholder="XÃ¡c nháº­n máº­t kháº©u má»›i">
        <button id="confirm-password-btn">XÃ¡c Nháº­n</button>
      </div>

      <div class="hidden" id="orders-container" style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
        <h3>Danh SÃ¡ch Mua HÃ ng</h3>
        <ul id="orders-list"></ul> 
        <button id="close-orders" style="margin-top: 10px;">ÄÃ³ng</button>
      </div>
    </div>
  </div> 
</main>

<script>
  // DOM Refs
  const loginContainer = document.getElementById('login-container');
  const registerContainer = document.getElementById('register-container');
  const homeContainer = document.getElementById('home-container');
  const infoContainer = document.getElementById('info-container');
  const forceChangePasswordContainer = document.getElementById('force-change-password-container');
  const changePasswordContainer = document.getElementById('change-password-container');
  const ordersContainer = document.getElementById('orders-container');
  const loginError = document.getElementById('login-error');
  const registerError = document.getElementById('register-error');
  const passwordError = document.getElementById('password-error');
  const forcePasswordError = document.getElementById('force-password-error');
  
  let currentUser = null;

  function show(container) {
    loginContainer.classList.add('hidden');
    registerContainer.classList.add('hidden');
    homeContainer.classList.add('hidden');
    infoContainer.classList.add('hidden');
    forceChangePasswordContainer.classList.add('hidden');
    container.classList.remove('hidden');
  }

  // ==================== MIGRATION ====================
  function migrateOldUsers() {
    const saved = localStorage.getItem('users');
    if (!saved) return;
    
    let users = JSON.parse(saved);
    let hasChanged = false;
    
    users = users.map((user, index) => {
      let updated = { ...user };
      
      if (!updated.id) {
        let maxNum = 0;
        users.forEach(u => {
          if (u.id && u.id.startsWith('KH')) {
            const num = parseInt(u.id.substring(2));
            if (num > maxNum) maxNum = num;
          }
        });
        updated.id = 'KH' + String(maxNum + index + 1).padStart(3, '0');
        hasChanged = true;
      }
      
      if (!updated.name) {
        updated.name = updated.username || 'User';
        hasChanged = true;
      }
      
      if (!updated.date) {
        updated.date = new Date().toLocaleDateString('vi-VN');
        hasChanged = true;
      }
      
      if (!updated.status) {
        updated.status = 'active';
        hasChanged = true;
      }
      
      if (!updated.orders) {
        updated.orders = [];
        hasChanged = true;
      }
      
      if (!updated.cart) {
        updated.cart = [];
        hasChanged = true;
      }
      
      if (!updated.address) {
        updated.address = '';
        hasChanged = true;
      }
      
      return updated;
    });
    
    if (hasChanged) {
      localStorage.setItem('users', JSON.stringify(users));
      console.log('âœ… [User] ÄÃ£ cáº­p nháº­t ' + users.length + ' tÃ i khoáº£n');
    }
  }



  // ==================== QUáº¢N LÃ Dá»® LIá»†U ====================
  function getUsers() {
    migrateOldUsers();
    return JSON.parse(localStorage.getItem('users') || '[]');
  }
  
  function saveUsers(users) {
    localStorage.setItem('users', JSON.stringify(users));
  }
  
  function setLoggedInUser(user) {
    currentUser = user;
    sessionStorage.setItem('currentUser', JSON.stringify(user));
  }
  
  function clearLoggedInUser() {
    currentUser = null;
    sessionStorage.removeItem('currentUser');
  }
  
  function syncCurrentUser() {
    const users = getUsers();
    if (currentUser) {
      const updatedUser = users.find(u => u.username === currentUser.username);
      if (updatedUser) {
        setLoggedInUser(updatedUser); 
      } else {
        clearLoggedInUser();
      }
    }
  }

  // ==================== ÄÄ‚NG NHáº¬P ====================
  document.getElementById('login-btn').addEventListener('click', () => {
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value;
    
    if (!username || !password) {
      loginError.textContent = 'Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin';
      return;
    }
    
    const users = getUsers();
    const user = users.find(u => u.username === username && u.password === password);
    
    if (user) {
      if (user.status === 'locked') {
        loginError.textContent = 'ğŸ”’ TÃ i khoáº£n Ä‘Ã£ bá»‹ khÃ³a. Vui lÃ²ng liÃªn há»‡ Admin!';
        return;
      }
      
      setLoggedInUser(user);
      loginError.textContent = '';
      
      document.getElementById('login-username').value = '';
      document.getElementById('login-password').value = '';
      
      // // âœ… KIá»‚M TRA: Náº¿u lÃ  Admin â†’ Chuyá»ƒn Ä‘áº¿n trang Admin
      // if (user.role === 'admin' && user.username === 'admin') {
      //   localStorage.setItem('adminLoggedIn', 'true');
      //   localStorage.setItem('adminInfo', JSON.stringify({
      //     username: user.username,
      //     name: user.name
      //   }));
        
      //   alert('âœ… ÄÄƒng nháº­p Admin thÃ nh cÃ´ng!\n\nBáº¡n sáº½ Ä‘Æ°á»£c chuyá»ƒn Ä‘áº¿n trang quáº£n lÃ½...');
      //   window.location.href = 'index.html'; // Chuyá»ƒn Ä‘áº¿n trang Admin
      //   return;
      // }
      
      // User thÆ°á»ng
      if (user.requirePasswordChange === true) {
        show(forceChangePasswordContainer);
        forcePasswordError.textContent = '';
      } else {
        show(homeContainer);
        document.getElementById('home-welcome').textContent = `ChÃ o má»«ng, ${user.name || user.username}`;
      }
    } else {
      loginError.textContent = 'Sai tÃªn Ä‘Äƒng nháº­p hoáº·c máº­t kháº©u';
    }
  });

  document.getElementById('goto-register').addEventListener('click', () => {
    show(registerContainer);
    registerError.textContent = '';
    loginError.textContent = '';
  });

  // ==================== ÄÄ‚NG KÃ ====================
  document.getElementById('register-btn').addEventListener('click', () => {
    const username = document.getElementById('register-username').value.trim();
    const password = document.getElementById('register-password').value;
    const confirmPassword = document.getElementById('register-confirm-password').value;
    const email = document.getElementById('register-email').value.trim();
    const users = getUsers();

    if (!username || !password || !confirmPassword || !email) {
      registerError.textContent = 'Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin'; 
      return;
    }

    if (password !== confirmPassword) {
      registerError.textContent = 'Máº­t kháº©u khÃ´ng khá»›p'; 
      return;
    }
    if (!email.includes('@')) {
      registerError.textContent = 'Email khÃ´ng há»£p lá»‡'; 
      return;
    }
    if (users.some(u => u.username === username)) {
      registerError.textContent = 'TÃªn Ä‘Äƒng nháº­p Ä‘Ã£ tá»“n táº¡i'; 
      return;
    }
    if (users.some(u => u.email === email)) {
      registerError.textContent = 'Email Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng'; 
      return;
    }

    let maxNum = 0;
    users.forEach(u => {
      if (u.id && u.id.startsWith('KH')) {
        const num = parseInt(u.id.substring(2));
        if (num > maxNum) maxNum = num;
      }
    });
    const newId = 'KH' + String(maxNum + 1).padStart(3, '0');
    const registerDate = new Date().toLocaleDateString('vi-VN');
    
    const newUser = { 
      id: newId,
      username: username,
      password: password,
      name: username,
      email: email,
      phone: '',
      address: '',
      date: registerDate,
      status: 'active',
      orders: [],
      cart: []
    };
    
    users.push(newUser);
    saveUsers(users);
    setLoggedInUser(newUser); 

    registerError.textContent = '';
    show(homeContainer);
    document.getElementById('home-welcome').textContent = `ChÃ o má»«ng, ${newUser.username}`;
    
    document.getElementById('register-username').value = '';
    document.getElementById('register-password').value = '';
    document.getElementById('register-confirm-password').value = '';
    document.getElementById('register-email').value = '';
  });

  document.getElementById('goto-login').addEventListener('click', () => {
    show(loginContainer);
    loginError.textContent = '';
    registerError.textContent = '';
  });

  // ==================== Äá»”I Máº¬T KHáº¨U Báº®T BUá»˜C ====================
  document.getElementById('force-confirm-password-btn').addEventListener('click', () => {
    if (!currentUser) return;
    
    const oldPass = document.getElementById('force-old-password').value;
    const newPass = document.getElementById('force-new-password').value;
    const confirmNew = document.getElementById('force-confirm-new-password').value;

    if (!oldPass || !newPass || !confirmNew) {
      forcePasswordError.textContent = 'Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin';
      return;
    }
    if (oldPass !== currentUser.password) {
      forcePasswordError.textContent = 'Máº­t kháº©u hiá»‡n táº¡i khÃ´ng Ä‘Ãºng'; 
      return;
    }
    if (newPass === oldPass) {
      forcePasswordError.textContent = 'Máº­t kháº©u má»›i pháº£i khÃ¡c máº­t kháº©u cÅ©';
      return;
    }
    if (newPass !== confirmNew) {
      forcePasswordError.textContent = 'Máº­t kháº©u má»›i khÃ´ng khá»›p'; 
      return;
    }

    currentUser.password = newPass;
    currentUser.requirePasswordChange = false;
    
    const users = getUsers();
    const index = users.findIndex(u => u.username === currentUser.username);
    
    if (index !== -1) {
      users[index] = currentUser;
      saveUsers(users);
      setLoggedInUser(currentUser); 
      
      forcePasswordError.textContent = '';
      
      document.getElementById('force-old-password').value = '';
      document.getElementById('force-new-password').value = '';
      document.getElementById('force-confirm-new-password').value = '';
      
      alert('âœ… Äá»•i máº­t kháº©u thÃ nh cÃ´ng!');
      show(homeContainer);
      document.getElementById('home-welcome').textContent = `ChÃ o má»«ng, ${currentUser.name || currentUser.username}`;
    }
  });

  document.getElementById('force-logout-btn').addEventListener('click', () => {
    clearLoggedInUser();
    show(loginContainer);
  });

  // ==================== TRANG CHÃNH ====================
  document.getElementById('logout-btn').addEventListener('click', () => {
    clearLoggedInUser();
    show(loginContainer);
  });
  
  document.getElementById('go-products').addEventListener('click', () => {
    window.location.href = 'sanpham.html';
  });
  
  document.getElementById('go-info').addEventListener('click', () => {
    checkAccountStatusRealtime();
    if (!currentUser) return;
    
    show(infoContainer);
    loadUserInfo();
    changePasswordContainer.classList.add('hidden');
    ordersContainer.classList.add('hidden');
  });

  // ==================== THÃ”NG TIN KHÃCH HÃ€NG ====================
  function loadUserInfo() {
    if (!currentUser) return; 
    document.getElementById('info-username').value = currentUser.name || currentUser.username;
    document.getElementById('info-phone').value = currentUser.phone || '';
    document.getElementById('info-email').value = currentUser.email || '';
    document.getElementById('info-address').value = currentUser.address || '';
  }

  document.getElementById('save-info').addEventListener('click', () => {
    if (!currentUser) return;
    
    const newPhone = document.getElementById('info-phone').value.trim();
    const newEmail = document.getElementById('info-email').value.trim();
    const newAddress = document.getElementById('info-address').value.trim();
    
    if (newEmail && !newEmail.includes('@')) {
      alert('Email khÃ´ng há»£p lá»‡');
      return;
    }
    
    currentUser.phone = newPhone;
    currentUser.email = newEmail;
    currentUser.address = newAddress;
    
    const users = getUsers();
    const index = users.findIndex(u => u.username === currentUser.username);
    if (index !== -1) {
      users[index] = currentUser;
      saveUsers(users);
      setLoggedInUser(currentUser);
      alert('âœ… ÄÃ£ lÆ°u thÃ´ng tin thÃ nh cÃ´ng');
    }
  });

  document.getElementById('back-home').addEventListener('click', () => {
    show(homeContainer);
  });

  // ==================== Äá»”I Máº¬T KHáº¨U ====================
  document.getElementById('change-password').addEventListener('click', () => {
    changePasswordContainer.classList.toggle('hidden');
    passwordError.textContent = '';
    document.getElementById('old-password').value = '';
    document.getElementById('new-password').value = '';
    document.getElementById('confirm-new-password').value = '';
  });

  document.getElementById('confirm-password-btn').addEventListener('click', () => {
    const oldPass = document.getElementById('old-password').value;
    const newPass = document.getElementById('new-password').value;
    const confirmNew = document.getElementById('confirm-new-password').value;

    if (!oldPass || !newPass || !confirmNew) {
      passwordError.textContent = 'Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin';
      return;
    }
    if (oldPass !== currentUser.password) {
      passwordError.textContent = 'Máº­t kháº©u cÅ© khÃ´ng Ä‘Ãºng'; 
      return;
    }
    if (newPass !== confirmNew) {
      passwordError.textContent = 'Máº­t kháº©u má»›i khÃ´ng khá»›p'; 
      return;
    }

    currentUser.password = newPass;
    const users = getUsers();
    const index = users.findIndex(u => u.username === currentUser.username);
    
    if (index !== -1) {
      users[index] = currentUser;
      saveUsers(users);
      setLoggedInUser(currentUser); 
      passwordError.textContent = '';
      changePasswordContainer.classList.add('hidden');
      alert('âœ… Äá»•i máº­t kháº©u thÃ nh cÃ´ng');
      
      document.getElementById('old-password').value = '';
      document.getElementById('new-password').value = '';
      document.getElementById('confirm-new-password').value = '';
    }
  });

  // ==================== XEM ÄÆ N HÃ€NG USER ====================
document.getElementById('view-orders').addEventListener('click', () => {
  ordersContainer.classList.toggle('hidden'); 
  if (ordersContainer.classList.contains('hidden')) return; 
  
  const ordersList = document.getElementById('orders-list');
  ordersList.innerHTML = ''; 
  syncCurrentUser(); 

  if (currentUser.orders && currentUser.orders.length > 0) {
    const sortedOrders = currentUser.orders.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    sortedOrders.forEach(order => {
      const li = document.createElement('li');
      li.className = 'order-card'; 

      const orderDate = new Date(order.date).toLocaleString('vi-VN', {
        day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
      });
      const orderTotal = order.total.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + 'Ä‘';
      const itemsHtml = order.items.map(item => 
        `<li>${item.title} (x${item.quantity})</li>`
      ).join('');

      // âœ… Xá»¬ LÃ TRáº NG THÃI - USER THáº¤Y "ÄÃƒ Äáº¶T HÃ€NG" THAY VÃŒ "Má»šI Äáº¶T"
      let statusDisplay = '';
      let actionButtons = '';
      
      switch(order.status) {
        case 'pending':
          statusDisplay = '<span style="color:#f59e0b; font-weight:600;">ğŸŸ¡ ÄÃ£ Ä‘áº·t hÃ ng</span>';
          actionButtons = `
            <button onclick="cancelOrder('${order.id}')" style="background:#ef4444; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer; margin-top:10px;">
              âŒ Há»§y Ä‘Æ¡n hÃ ng
            </button>
          `;
          break;
          
        case 'processing':
          statusDisplay = '<span style="color:#3b82f6; font-weight:600;">ğŸ”µ Äang xá»­ lÃ½</span>';
          actionButtons = '<p style="color:#3b82f6; font-size:13px; margin-top:10px;">â³ Admin Ä‘ang xá»­ lÃ½ Ä‘Æ¡n hÃ ng cá»§a báº¡n...</p>';
          break;
          
        case 'shipped':
          statusDisplay = '<span style="color:#10b981; font-weight:600;">ğŸšš ÄÃ£ giao hÃ ng</span>';
          actionButtons = `
            <p style="color:#10b981; font-size:13px; margin-top:10px;">
              ğŸ“¦ ÄÆ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c giao Ä‘áº¿n báº¡n
            </p>
            <button onclick="confirmReceived('${order.id}')" style="background:#10b981; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer; margin-top:10px;">
              âœ… ÄÃ£ nháº­n hÃ ng
            </button>
          `;
          break;
          
        case 'completed':
          statusDisplay = '<span style="color:#10b981; font-weight:600;">âœ… HoÃ n thÃ nh</span>';
          actionButtons = '<p style="color:#10b981; font-size:13px; margin-top:10px;">âœ… ÄÆ¡n hÃ ng Ä‘Ã£ hoÃ n thÃ nh</p>';
          break;
          
        case 'cancelled':
          statusDisplay = '<span style="color:#ef4444; font-weight:600;">âŒ ÄÃ£ há»§y</span>';
          const cancelReason = order.cancelledBy === 'admin' 
            ? '<p style="color:#ef4444; font-size:13px; margin-top:10px;">âš ï¸ Admin Ä‘Ã£ há»§y Ä‘Æ¡n hÃ ng nÃ y</p>'
            : '<p style="color:#999; font-size:13px; margin-top:10px;">Báº¡n Ä‘Ã£ há»§y Ä‘Æ¡n hÃ ng nÃ y</p>';
          actionButtons = cancelReason;
          break;
      }

      li.innerHTML = `
        <div class="order-card-header">
          <span class="order-id">${order.id}</span>
          <span class="order-total">${orderTotal}</span>
        </div>
        <div class="order-card-body">
          <p><strong>NgÃ y Ä‘áº·t:</strong> ${orderDate}</p>
          <p><strong>Tráº¡ng thÃ¡i:</strong> ${statusDisplay}</p>
          <p><strong>Giao Ä‘áº¿n:</strong> ${order.shippingAddress.name} - ${order.shippingAddress.address}</p>
          <p><strong>Thanh toÃ¡n:</strong> ${order.paymentMethod}</p>
          <p><strong>Sáº£n pháº©m:</strong></p>
          <ul class="order-items-list">
            ${itemsHtml}
          </ul>
          ${actionButtons}
        </div>
      `;
      ordersList.appendChild(li);
    });
  } else {
    ordersList.innerHTML = '<li style="padding:10px; text-align:center; color: #777;">ChÆ°a cÃ³ lá»‹ch sá»­ mua hÃ ng.</li>';
  }
});

// âœ… Há»¦Y ÄÆ N HÃ€NG (USER)
function cancelOrder(orderId) {
  if (!confirm('âš ï¸ Báº¡n cÃ³ cháº¯c muá»‘n Há»¦Y Ä‘Æ¡n hÃ ng nÃ y?\n\nThao tÃ¡c nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c!')) {
    return;
  }
  
  const users = getUsers();
  const userIndex = users.findIndex(u => u.username === currentUser.username);
  
  if (userIndex !== -1) {
    const orderIndex = users[userIndex].orders.findIndex(o => o.id === orderId);
    
    if (orderIndex !== -1) {
      // Chá»‰ cho há»§y khi Ä‘Æ¡n Ä‘ang á»Ÿ tráº¡ng thÃ¡i "pending"
      if (users[userIndex].orders[orderIndex].status !== 'pending') {
        alert('âŒ KhÃ´ng thá»ƒ há»§y Ä‘Æ¡n hÃ ng Ä‘ang Ä‘Æ°á»£c xá»­ lÃ½!');
        return;
      }
      
      users[userIndex].orders[orderIndex].status = 'cancelled';
      users[userIndex].orders[orderIndex].cancelledBy = 'user';
      users[userIndex].orders[orderIndex].cancelledAt = new Date().toISOString();
      
      saveUsers(users);
      setLoggedInUser(users[userIndex]);
      
      alert('âœ… ÄÃ£ há»§y Ä‘Æ¡n hÃ ng thÃ nh cÃ´ng!');
      
      // Refresh danh sÃ¡ch
      document.getElementById('view-orders').click();
      document.getElementById('view-orders').click();
    }
  }
}

// âœ… XÃC NHáº¬N NHáº¬N HÃ€NG (USER)
function confirmReceived(orderId) {
  if (!confirm('âœ… XÃ¡c nháº­n báº¡n Ä‘Ã£ nháº­n Ä‘Æ°á»£c hÃ ng?\n\nÄÆ¡n hÃ ng sáº½ Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u hoÃ n thÃ nh.')) {
    return;
  }
  
  const users = getUsers();
  const userIndex = users.findIndex(u => u.username === currentUser.username);
  
  if (userIndex !== -1) {
    const orderIndex = users[userIndex].orders.findIndex(o => o.id === orderId);
    
    if (orderIndex !== -1) {
      users[userIndex].orders[orderIndex].status = 'completed';
      users[userIndex].orders[orderIndex].completedAt = new Date().toISOString();
      
      saveUsers(users);
      setLoggedInUser(users[userIndex]);
      
      alert('âœ… Cáº£m Æ¡n báº¡n Ä‘Ã£ xÃ¡c nháº­n!\n\nÄÆ¡n hÃ ng Ä‘Ã£ hoÃ n thÃ nh.');
      
      // Refresh danh sÃ¡ch
      document.getElementById('view-orders').click();
      document.getElementById('view-orders').click();
    }
  }
}

document.getElementById('close-orders').addEventListener('click', () => {
  ordersContainer.classList.add('hidden');
});


document.getElementById('close-orders').addEventListener('click', () => {
  ordersContainer.classList.add('hidden');
});
  // ==================== KIá»‚M TRA REALTIME ====================
  function checkAccountStatusRealtime() {
    if (!currentUser) return;
    
    const users = getUsers();
    const latestUser = users.find(u => u.username === currentUser.username);
    
    if (!latestUser) {
      alert('âš ï¸ TÃ i khoáº£n khÃ´ng tá»“n táº¡i. Vui lÃ²ng liÃªn há»‡ Admin!');
      clearLoggedInUser();
      show(loginContainer);
      return;
    }
    
    if (latestUser.status === 'locked') {
      alert('ğŸ”’ TÃ i khoáº£n cá»§a báº¡n Ä‘Ã£ bá»‹ khÃ³a bá»Ÿi Admin!\nBáº¡n sáº½ Ä‘Æ°á»£c Ä‘Äƒng xuáº¥t.');
      clearLoggedInUser();
      show(loginContainer);
      return;
    }
    
    if (latestUser.requirePasswordChange === true && currentUser.requirePasswordChange !== true) {
      alert('âš ï¸ Admin yÃªu cáº§u báº¡n Ä‘á»•i máº­t kháº©u.\nVui lÃ²ng Ä‘á»•i máº­t kháº©u Ä‘á»ƒ tiáº¿p tá»¥c!');
      setLoggedInUser(latestUser);
      show(forceChangePasswordContainer);
      forcePasswordError.textContent = '';
      return;
    }
    
    setLoggedInUser(latestUser);
  }

  setInterval(checkAccountStatusRealtime, 2000);

  // ==================== KHá»I Táº O ====================
  function initialize() {
    
    const storedUser = sessionStorage.getItem('currentUser');
    if (storedUser) {
      currentUser = JSON.parse(storedUser);
      syncCurrentUser(); 
      if (currentUser) {
        if (currentUser.requirePasswordChange === true) {
          show(forceChangePasswordContainer);
        } else {
          show(homeContainer);
          document.getElementById('home-welcome').textContent = `ChÃ o má»«ng, ${currentUser.name || currentUser.username}`;
        }
      } else {
        show(loginContainer);
      }
    } else {
      show(loginContainer);
    }
  }
  
  initialize();
</script>
</body>
</html>