<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>T√†i kho·∫£n ‚Äî C·ª≠a h√†ng S√°ch Vi·ªát</title>
  
  <link rel="stylesheet" href="./css/style_sanpham.css">

  <style>
    /* CSS G·ªëc c·ªßa file n√†y */
    .form-wrapper {
      background: #fff;
      padding: 20px 40px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      width: 350px; 
      margin: 40px auto; 
    }

    .form-wrapper h2 { text-align: center; margin-bottom: 20px; }
    .form-wrapper input[type="text"],
    .form-wrapper input[type="password"],
    .form-wrapper input[type="email"],
    .form-wrapper input[type="tel"] {
      width: 100%; padding: 8px; margin: 5px 0 15px 0;
      border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; 
    }
    .form-wrapper button {
      width: 100%; padding: 10px; margin: 5px 0; border: none;
      border-radius: 4px; background: #007bff; color: white;
      cursor: pointer; font-size: 16px;
    }
    .form-wrapper button:hover { background: #0056b3; }
    .form-wrapper .secondary-btn { background: #6c757d; }
    .form-wrapper .secondary-btn:hover { background: #495057; }
    .form-wrapper .error { color: red; text-align: center; margin-bottom: 10px; }
    .hidden { display: none; }
    .form-wrapper textarea { width: 100%; height: 50px; resize: none; }
    .form-wrapper label { font-weight: bold; }

    /* CSS Ki·ªÉu cho ƒê∆°n h√†ng */
    #orders-list {
      list-style-type: none; padding: 0;
      max-height: 400px; overflow-y: auto;
      background: #fdfdfd; border-top: 1px solid #eee; padding-top: 10px;
    }
    .order-card {
      background: #f9f9f9; border: 1px solid #eee; border-radius: 8px;
      padding: 12px; margin-bottom: 10px;
    }
    .order-card-header {
      display: flex; justify-content: space-between; align-items: center;
      font-weight: bold; font-size: 14px; border-bottom: 1px solid #ddd;
      padding-bottom: 8px; margin-bottom: 8px;
    }
    .order-card-header .order-id { color: var(--primary); font-size: 13px; }
    .order-card-header .order-total { color: #2c3e50; font-size: 15px; }
    .order-card-body { font-size: 13px; color: #555; }
    .order-card-body p { margin: 4px 0; }
    .order-items-list {
      font-size: 12px; padding-left: 16px;
      color: #777; margin-top: 5px;
    }
    .order-items-list li { margin-bottom: 3px; }

  </style>
</head>
<body>

<header class="site-header">
  <div class="container">
    <div class="header-top">
      <div class="brand">
        <div class="logo" aria-hidden="true">üìò</div>
        <div>
          <div style="font-size:20px">C·ª≠a h√†ng S√°ch Vi·ªát</div>
          <div style="font-size:12px;color:rgba(255,255,255,0.85)">Qu·∫£n l√Ω t√†i kho·∫£n</div>
        </div>
      </div>
      <nav class="user-nav">
        <a href="./sanpham.html" title="Trang ch·ªß">
          <span class="icon">üè†</span>
          <span class="label">Trang ch·ªß</span>
        </a>
        <a href="./giohang.html" title="Gi·ªè h√†ng">
          <span class="icon">üõí</span>
          <span class="label">Gi·ªè h√†ng</span>
        </a>
        <a href="#" title="T√†i kho·∫£n" class="active">
          <span class="icon">üë§</span>
          <span class="label">T√†i kho·∫£n</span>
        </a>
      </nav>
      </div>
  </div>
</header>

<main>
  <div class="container"> 
    
    <div class="form-wrapper" id="login-container">
      <h2>ƒêƒÉng Nh·∫≠p</h2>
      <div class="error" id="login-error"></div>
      <input type="text" id="login-username" placeholder="T√™n ƒëƒÉng nh·∫≠p">
      <input type="password" id="login-password" placeholder="M·∫≠t kh·∫©u">
      <button id="login-btn">ƒêƒÇNG NH·∫¨P</button>
      <button class="secondary-btn" id="goto-register">CHUY·ªÇN SANG ƒêƒÇNG K√ç</button>
    </div>

    <div class="form-wrapper hidden" id="register-container">
      <h2>ƒêƒÉng K√≠</h2>
      <div class="error" id="register-error"></div>
      <input type="text" id="register-username" placeholder="T√™n ƒëƒÉng nh·∫≠p m·ªõi">
      <input type="password" id="register-password" placeholder="M·∫≠t kh·∫©u">
      <input type="password" id="register-confirm-password" placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u">
      <input type="email" id="register-email" placeholder="Email">
      <button id="register-btn">ƒêƒÇNG K√ç</button>
      <button class="secondary-btn" id="goto-login">QUAY L·∫†I ƒêƒÇNG NH·∫¨P</button>
    </div>

    <div class="form-wrapper hidden" id="home-container">
      <h2 id="home-welcome">Trang Ch√≠nh</h2>
      <button id="go-products">Xem S·∫£n Ph·∫©m</button>
      <button id="go-info">Th√¥ng Tin Kh√°ch H√†ng</button>
      <button class="secondary-btn" id="logout-btn">ƒêƒÇNG XU·∫§T</button>
    </div>

    <div class="form-wrapper hidden" id="info-container">
      <h2>Th√¥ng Tin Kh√°ch H√†ng</h2>
      <label>T√™n kh√°ch h√†ng:</label>
      <input type="text" id="info-username" disabled>
      <label>S·ªë ƒëi·ªán tho·∫°i:</label>
      <input type="tel" id="info-phone">
      <label>Email:</label>
      <input type="email" id="info-email">
      
      <label>ƒê·ªãa ch·ªâ (M·∫∑c ƒë·ªãnh):</label>
      <input type="text" id="info-address" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng/x√£...">
      
      <button id="save-info">L∆∞u Th√¥ng Tin</button>
      <button id="change-password">ƒê·ªïi M·∫≠t Kh·∫©u</button>
      <button id="view-orders">Danh S√°ch Mua H√†ng</button>
      <button class="secondary-btn" id="back-home">Quay L·∫°i Trang Ch√≠nh</button>

      <div class="hidden" id="change-password-container" style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
        <h3>ƒê·ªïi M·∫≠t Kh·∫©u</h3>
        <div class="error" id="password-error"></div>
        <input type="password" id="old-password" placeholder="M·∫≠t kh·∫©u c≈©">
        <input type="password" id="new-password" placeholder="M·∫≠t kh·∫©u m·ªõi">
        <input type="password" id="confirm-new-password" placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi">
        <button id="confirm-password-btn">X√°c Nh·∫≠n</button>
      </div>

      <div class="hidden" id="orders-container" style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
        <h3>Danh S√°ch Mua H√†ng</h3>
        <ul id="orders-list"></ul> 
        <button id="close-orders" style="margin-top: 10px;">ƒê√≥ng</button>
      </div>
    </div>
  </div> 
</main>

<script>
  // DOM Refs
  const loginContainer = document.getElementById('login-container');
  const registerContainer = document.getElementById('register-container');
  const homeContainer = document.getElementById('home-container');
  const infoContainer = document.getElementById('info-container');
  const changePasswordContainer = document.getElementById('change-password-container');
  const ordersContainer = document.getElementById('orders-container');
  const loginError = document.getElementById('login-error');
  const registerError = document.getElementById('register-error');
  const passwordError = document.getElementById('password-error');
  // State
  let currentUser = null;

  function show(container) {
    loginContainer.classList.add('hidden');
    registerContainer.classList.add('hidden');
    homeContainer.classList.add('hidden');
    infoContainer.classList.add('hidden');
    container.classList.remove('hidden');
  }

  // --- QU·∫¢N L√ù D·ªÆ LI·ªÜU ---
  function getUsers() {
    return JSON.parse(localStorage.getItem('users') || '[]');
  }
  function saveUsers(users) {
    localStorage.setItem('users', JSON.stringify(users));
  }
  function setLoggedInUser(user) {
    currentUser = user;
    sessionStorage.setItem('currentUser', JSON.stringify(user));
  }
  function clearLoggedInUser() {
    currentUser = null;
    sessionStorage.removeItem('currentUser');
  }
  function syncCurrentUser() {
    const users = getUsers();
    if (currentUser) {
      const updatedUser = users.find(u => u.username === currentUser.username);
      if (updatedUser) {
        setLoggedInUser(updatedUser); 
      } else {
        clearLoggedInUser();
      }
    }
  }

  // -------------------- ƒêƒÉng nh·∫≠p --------------------
  document.getElementById('login-btn').addEventListener('click', () => {
    const username = document.getElementById('login-username').value;
    const password = document.getElementById('login-password').value;
    const users = getUsers();
    const user = users.find(u => u.username === username && u.password === password);
    if (user) {
      setLoggedInUser(user);
      show(homeContainer);
      document.getElementById('home-welcome').textContent = `Ch√†o m·ª´ng, ${user.username}`;
      loginError.textContent = '';
    } else {
      loginError.textContent = 'Sai th√¥ng tin ƒëƒÉng nh·∫≠p';
    }
  });

  document.getElementById('goto-register').addEventListener('click', () => {
    show(registerContainer);
    registerError.textContent = '';
  });

  // -------------------- ƒêƒÉng k√≠ (C·∫¨P NH·∫¨T) --------------------
  document.getElementById('register-btn').addEventListener('click', () => {
    const username = document.getElementById('register-username').value;
    const password = document.getElementById('register-password').value;
    const confirmPassword = document.getElementById('register-confirm-password').value;
    const email = document.getElementById('register-email').value;
    const users = getUsers();

    if (!username || !password || !confirmPassword || !email) {
      registerError.textContent = 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin'; return;
    }
    if (password !== confirmPassword) {
      registerError.textContent = 'M·∫≠t kh·∫©u kh√¥ng kh·ªõp'; return;
    }
    if (users.some(u => u.username === username)) {
      registerError.textContent = 'T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i'; return;
    }

    // Th√™m 'address: ""' cho user m·ªõi
    const newUser = { username, password, email, phone: '', address: '', orders: [], cart: [] };
    users.push(newUser);
    saveUsers(users);
    setLoggedInUser(newUser); 

    registerError.textContent = '';
    show(homeContainer);
    document.getElementById('home-welcome').textContent = `Ch√†o m·ª´ng, ${newUser.username}`;
  });

  document.getElementById('goto-login').addEventListener('click', () => {
    show(loginContainer);
    loginError.textContent = '';
  });

  // -------------------- Trang ch√≠nh --------------------
  document.getElementById('logout-btn').addEventListener('click', () => {
    clearLoggedInUser();
    show(loginContainer);
  });
  document.getElementById('go-products').addEventListener('click', () => {
    window.location.href = 'sanpham.html';
  });
  document.getElementById('go-info').addEventListener('click', () => {
    show(infoContainer);
    loadUserInfo();
    changePasswordContainer.classList.add('hidden');
    ordersContainer.classList.add('hidden');
  });

  // -------------------- Th√¥ng tin kh√°ch h√†ng (C·∫¨P NH·∫¨T) --------------------
  function loadUserInfo() {
    if (!currentUser) return; 
    document.getElementById('info-username').value = currentUser.username;
    document.getElementById('info-phone').value = currentUser.phone || '';
    document.getElementById('info-email').value = currentUser.email || '';
    // Load ƒë·ªãa ch·ªâ ƒë√£ l∆∞u
    document.getElementById('info-address').value = currentUser.address || '';
  }

  document.getElementById('save-info').addEventListener('click', () => {
    if (!currentUser) return;
    currentUser.phone = document.getElementById('info-phone').value;
    currentUser.email = document.getElementById('info-email').value;
    // L∆∞u ƒë·ªãa ch·ªâ
    currentUser.address = document.getElementById('info-address').value;
    
    const users = getUsers();
    const index = users.findIndex(u => u.username === currentUser.username);
    if (index !== -1) {
      users[index] = currentUser;
      saveUsers(users);
      setLoggedInUser(currentUser);
      alert('ƒê√£ l∆∞u th√¥ng tin');
    }
  });

  document.getElementById('back-home').addEventListener('click', () => {
    show(homeContainer);
  });

  // -------------------- ƒê·ªïi m·∫≠t kh·∫©u --------------------
  document.getElementById('change-password').addEventListener('click', () => {
    changePasswordContainer.classList.toggle('hidden');
    passwordError.textContent = '';
  });

  document.getElementById('confirm-password-btn').addEventListener('click', () => {
    const oldPass = document.getElementById('old-password').value;
    const newPass = document.getElementById('new-password').value;
    const confirmNew = document.getElementById('confirm-new-password').value;

    if (oldPass !== currentUser.password) {
      passwordError.textContent = 'M·∫≠t kh·∫©u c≈© kh√¥ng ƒë√∫ng'; return;
    }
    if (!newPass || newPass !== confirmNew) {
      passwordError.textContent = 'M·∫≠t kh·∫©u m·ªõi kh√¥ng kh·ªõp ho·∫∑c b·ªã b·ªè tr·ªëng'; return;
    }

    currentUser.password = newPass;
    const users = getUsers();
    const index = users.findIndex(u => u.username === currentUser.username);
    
    if (index !== -1) {
      users[index] = currentUser;
      saveUsers(users);
      setLoggedInUser(currentUser); 
      passwordError.textContent = '';
      changePasswordContainer.classList.add('hidden');
      alert('ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng');
    }
  });

  // -------------------- Xem ƒë∆°n h√†ng --------------------
  document.getElementById('view-orders').addEventListener('click', () => {
    ordersContainer.classList.toggle('hidden'); 
    if (ordersContainer.classList.contains('hidden')) return; 
    
    const ordersList = document.getElementById('orders-list');
    ordersList.innerHTML = ''; 
    syncCurrentUser(); 

    if (currentUser.orders && currentUser.orders.length > 0) {
      const sortedOrders = currentUser.orders.sort((a, b) => new Date(b.date) - new Date(a.date));
      sortedOrders.forEach(order => {
        const li = document.createElement('li');
        li.className = 'order-card'; 

        const orderDate = new Date(order.date).toLocaleDateString('vi-VN', {
          day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
        });
        const orderTotal = order.total.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + 'ƒë';
        const itemsHtml = order.items.map(item => 
          `<li>${item.title} (x${item.quantity})</li>`
        ).join('');

        li.innerHTML = `
          <div class="order-card-header">
            <span class="order-id">${order.id}</span>
            <span class="order-total">${orderTotal}</span>
          </div>
          <div class="order-card-body">
            <p><strong>Ng√†y ƒë·∫∑t:</strong> ${orderDate}</p>
            <p><strong>Giao ƒë·∫øn:</strong> ${order.shippingAddress.name} - ${order.shippingAddress.address}</p>
            <p><strong>Thanh to√°n:</strong> ${order.paymentMethod}</p>
            <p><strong>S·∫£n ph·∫©m:</strong></p>
            <ul class="order-items-list">
              ${itemsHtml}
            </ul>
          </div>
        `;
        ordersList.appendChild(li);
      });
    } else {
      ordersList.innerHTML = '<li style="padding:10px; text-align:center; color: #777;">Ch∆∞a c√≥ l·ªãch s·ª≠ mua h√†ng.</li>';
    }
  });

  document.getElementById('close-orders').addEventListener('click', () => {
    ordersContainer.classList.add('hidden');
  });

  // -------------------- KH·ªûI T·∫†O --------------------
  function initialize() {
    const storedUser = sessionStorage.getItem('currentUser');
    if (storedUser) {
      currentUser = JSON.parse(storedUser);
      syncCurrentUser(); 
      show(homeContainer);
      document.getElementById('home-welcome').textContent = `Ch√†o m·ª´ng, ${currentUser.username}`;
    } else {
      show(loginContainer);
    }
  }
  initialize();
</script>
</body>
</html>